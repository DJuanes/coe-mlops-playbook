
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Playbook de Ingeniería de Machine Learning de CoE Analytics">
      
      
        <meta name="author" content="YPF - CoE Analytics">
      
      
      <link rel="icon" href="../../resources/YPF.svg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.2.16">
    
    
      
        <title>Testing de Modelos - CoE MLOps Playbook</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1c3799f8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testing-de-modelos" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CoE MLOps Playbook" class="md-header__button md-logo" aria-label="CoE MLOps Playbook" data-md-component="logo">
      
  <img src="../../resources/YPF.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CoE MLOps Playbook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Testing de Modelos
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/DJuanes/coe-mlops-playbook" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CoE MLOps Playbook" class="md-nav__button md-logo" aria-label="CoE MLOps Playbook" data-md-component="logo">
      
  <img src="../../resources/YPF.svg" alt="logo">

    </a>
    CoE MLOps Playbook
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DJuanes/coe-mlops-playbook" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Diseño
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Diseño" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Diseño
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Producto.md" class="md-nav__link">
        Producto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Ingeniería.md" class="md-nav__link">
        Ingeniería
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Proyecto.md" class="md-nav__link">
        Proyecto
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Datos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Datos" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Datos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Etiquetado.md" class="md-nav__link">
        Etiquetado
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Exploración.md" class="md-nav__link">
        Exploración
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Preprocesamiento.md" class="md-nav__link">
        Preprocesamiento
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Splitting.md" class="md-nav__link">
        Splitting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Aumento.md" class="md-nav__link">
        Aumento
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Modelado
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Modelado" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Modelado
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Líneas base.md" class="md-nav__link">
        Líneas base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Evaluación.md" class="md-nav__link">
        Evaluación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Seguimiento de experimentos.md" class="md-nav__link">
        Seguimiento de experimentos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Optimización.md" class="md-nav__link">
        Optimización
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5">
          Desarrollo
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Desarrollo" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Desarrollo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Empaquetado.md" class="md-nav__link">
        Empaquetado
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Organización.md" class="md-nav__link">
        Organización
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Logging.md" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Documentación.md" class="md-nav__link">
        Documentación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Estilismo.md" class="md-nav__link">
        Estilismo
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Makefile.md" class="md-nav__link">
        Makefile
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6">
          Inferencia
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Inferencia" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Inferencia
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Línea de comando.md" class="md-nav__link">
        Línea de comando
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/API RESTful.md" class="md-nav__link">
        API RESTful
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#entrenamiento" class="md-nav__link">
    Entrenamiento
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pruebas-de-comportamiento" class="md-nav__link">
    Pruebas de comportamiento
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inferencia" class="md-nav__link">
    Inferencia
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="testing-de-modelos">Testing de Modelos</h1>
<p>El último aspecto de las pruebas de los sistemas de ML consiste en probar nuestros modelos durante el entrenamiento, la evaluación, la inferencia y el despliegue.</p>
<h2 id="entrenamiento">Entrenamiento</h2>
<p>Queremos escribir pruebas de forma iterativa mientras desarrollamos nuestros pipelines de entrenamiento para poder detectar errores rápidamente.
Esto es especialmente importante porque, a diferencia del software tradicional, los sistemas de ML pueden ejecutarse hasta el final sin lanzar ninguna excepción/error,
pero pueden producir sistemas incorrectos. Además, queremos detectar los errores rápidamente para ahorrar tiempo y computo.</p>
<ul>
<li>
<p>Comprobar las formas y los valores de los resultados del modelo</p>
<div class="highlight"><pre><span></span><code><span class="k">assert</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="n">num_classes</span><span class="p">])</span>
</code></pre></div>
</li>
<li>
<p>Comprobar la disminución de la pérdida después de una tanda de entrenamiento</p>
<div class="highlight"><pre><span></span><code><span class="k">assert</span> <span class="n">epoch_loss</span> <span class="o">&lt;</span> <span class="n">prev_epoch_loss</span>
</code></pre></div>
</li>
<li>
<p>Sobreajuste en un batch</p>
<div class="highlight"><pre><span></span><code><span class="n">accuracy</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">batches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">accuracy</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="nb">abs</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span> <span class="c1"># 0.95 ± 0.05</span>
</code></pre></div>
</li>
<li>
<p>Entrenar hasta la finalización (pruebas de parada anticipada, guardado, etc.)</p>
<div class="highlight"><pre><span></span><code><span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">learning_rate</span> <span class="o">&gt;=</span> <span class="n">min_learning_rate</span>
<span class="k">assert</span> <span class="n">artifacts</span>
</code></pre></div>
</li>
<li>
<p>En diferentes dispositivos</p>
<div class="highlight"><pre><span></span><code><span class="k">assert</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">))</span>
</code></pre></div>
</li>
</ul>
<p>Puede marcar las pruebas de cálculo intensivo con un marcador pytest y sólo ejecutarlas cuando se produzca un cambio en el sistema que afecte al modelo.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">training</span>
<span class="k">def</span> <span class="nf">test_train_model</span><span class="p">():</span>
    <span class="o">...</span>
</code></pre></div>
<h2 id="pruebas-de-comportamiento">Pruebas de comportamiento</h2>
<p>Las pruebas de comportamiento (behavioral testing) son el proceso de probar los datos de entrada y los resultados esperados mientras se trata el modelo como una caja negra.
Un artículo de referencia sobre este tema es <a href="https://arxiv.org/abs/2005.04118">Beyond Accuracy: Behavioral Testing of NLP Models with CheckList</a>,
que desglosa las pruebas de comportamiento en tres tipos de pruebas:</p>
<ul>
<li>
<p><strong>invarianza</strong>: Los cambios no deben afectar a los resultados.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># INVariance a través de inyección de verbos (los cambios no deberían afectar los resultados).</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;revolutionized&quot;</span><span class="p">,</span> <span class="s2">&quot;disrupted&quot;</span><span class="p">]</span>
<span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Transformers applied to NLP have </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2"> the ML field.&quot;</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
<span class="n">predict</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span> <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p><strong>direccional</strong>: El cambio debe afectar a las salidas.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Expectativas DIReccionales (cambios con resultados conocidos).</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;text classification&quot;</span><span class="p">,</span> <span class="s2">&quot;image classification&quot;</span><span class="p">]</span>
<span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ML applied to </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
<span class="n">predict</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span> <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p><strong>funcionalidad mínima</strong>: Combinación simple de entradas y salidas previstas.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Pruebas de Funcionalidad Mínima (pares simples de entrada/salida).</span>
<span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;natural language processing&quot;</span><span class="p">,</span> <span class="s2">&quot;mlops&quot;</span><span class="p">]</span>
<span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2"> is the next big wave in machine learning.&quot;</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
<span class="n">predict</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span> <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">)</span>
</code></pre></div>
</li>
</ul>
<p>Y podemos convertir estas pruebas en pruebas sistemáticas parametrizadas:</p>
<div class="highlight"><pre><span></span><code>mkdir tests/model
touch tests/model/test_behavioral.py
</code></pre></div>
<details>
<summary>Ver tests/model/test_behavioral.py</summary>

<div class="highlight"><pre><span></span><code><span class="c1"># tests/model/test_behavioral.py</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">coe_template</span> <span class="kn">import</span> <span class="n">main</span><span class="p">,</span> <span class="n">predict</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">artifacts</span><span class="p">():</span>
    <span class="n">run_id</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG_DIR</span><span class="p">,</span> <span class="s2">&quot;run_id.txt&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">artifacts</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">load_artifacts</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">artifacts</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;text, tag&quot;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;Transformers applied to NLP have revolutionized machine learning.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;natural-language-processing&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;Transformers applied to NLP have disrupted machine learning.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;natural-language-processing&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_inv</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;INVariance a través de inyección de verbos (los cambios no deberían afectar los resultados).&quot;&quot;&quot;</span>
    <span class="n">predicted_tag</span> <span class="o">=</span> <span class="n">predict</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="p">[</span><span class="n">text</span><span class="p">],</span> <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;predicted_tag&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">predicted_tag</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;text, tag&quot;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;ML applied to text classification.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;natural-language-processing&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;ML applied to image classification.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;computer-vision&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;CNNs for text classification.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;natural-language-processing&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_dir</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expectativas DIReccionales (cambios con resultados conocidos).&quot;&quot;&quot;</span>
    <span class="n">predicted_tag</span> <span class="o">=</span> <span class="n">predict</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="p">[</span><span class="n">text</span><span class="p">],</span> <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;predicted_tag&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">predicted_tag</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;text, tag&quot;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;Natural language processing is the next big wave in machine learning.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;natural-language-processing&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;MLOps is the next big wave in machine learning.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mlops&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;This should not produce any relevant topics.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;other&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_mft</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pruebas de Funcionalidad Mínima (pares simples de entrada/salida).&quot;&quot;&quot;</span>
    <span class="n">predicted_tag</span> <span class="o">=</span> <span class="n">predict</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="p">[</span><span class="n">text</span><span class="p">],</span> <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;predicted_tag&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">predicted_tag</span>
</code></pre></div>

</details>

<h2 id="inferencia">Inferencia</h2>
<p>Cuando nuestro modelo se despliegue, los usuarios lo utilizarán para la inferencia (directa / indirectamente), por lo que es muy importante que probemos todos sus aspectos.</p>
<p><strong>Carga de artefactos</strong>
Esta es la primera vez que no cargamos nuestros componentes desde la memoria, por lo que queremos asegurarnos de que los artefactos necesarios
(model weights, encoders, config, etc.) son capaces de ser cargados.</p>
<div class="highlight"><pre><span></span><code><span class="n">artifacts</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">load_artifacts</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;label_encoder&quot;</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">LabelEncoder</span><span class="p">)</span>
<span class="o">...</span>
</code></pre></div>
<p><strong>Predicción</strong>
Una vez que tenemos nuestros artefactos cargados, estamos listos para probar el pipeline de predicción. Deberíamos probar las muestras con una sola entrada, así como con un lote de entradas.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># probar nuestra llamada API directamente</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;texts&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Transfer learning with transformers for text classification.&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Generative adversarial networks in both PyTorch and TensorFlow.&quot;</span><span class="p">},</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/predict&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span>
<span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;predictions&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;texts&quot;</span><span class="p">])</span>
<span class="o">...</span>
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3a4b43e5.min.js"></script>
      
    
  </body>
</html>