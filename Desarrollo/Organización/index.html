
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Playbook de Ingeniería de Machine Learning de CoE Analytics">
      
      
        <meta name="author" content="YPF - CoE Analytics">
      
      
      <link rel="icon" href="../../resources/YPF.svg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.2.16">
    
    
      
        <title>Organización - CoE MLOps Playbook</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1c3799f8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#organizacion-del-codigo-de-machine-learning" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CoE MLOps Playbook" class="md-header__button md-logo" aria-label="CoE MLOps Playbook" data-md-component="logo">
      
  <img src="../../resources/YPF.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CoE MLOps Playbook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Organización
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/DJuanes/coe-mlops-playbook" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CoE MLOps Playbook" class="md-nav__button md-logo" aria-label="CoE MLOps Playbook" data-md-component="logo">
      
  <img src="../../resources/YPF.svg" alt="logo">

    </a>
    CoE MLOps Playbook
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DJuanes/coe-mlops-playbook" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Diseño
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Diseño" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Diseño
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Dise%C3%B1o/Producto/" class="md-nav__link">
        Producto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Dise%C3%B1o/Ingenier%C3%ADa/" class="md-nav__link">
        Ingeniería
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Dise%C3%B1o/Proyecto/" class="md-nav__link">
        Proyecto
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Datos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Datos" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Datos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Datos/Etiquetado/" class="md-nav__link">
        Etiquetado
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Datos/Exploraci%C3%B3n/" class="md-nav__link">
        Exploración
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Datos/Preprocesamiento/" class="md-nav__link">
        Preprocesamiento
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Datos/Splitting/" class="md-nav__link">
        Splitting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Datos/Aumento/" class="md-nav__link">
        Aumento
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Modelado
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Modelado" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Modelado
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Modelado/L%C3%ADneas%20base/" class="md-nav__link">
        Líneas base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Modelado/Evaluaci%C3%B3n/" class="md-nav__link">
        Evaluación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Modelado/Seguimiento%20de%20experimentos/" class="md-nav__link">
        Seguimiento de experimentos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Modelado/Optimizaci%C3%B3n/" class="md-nav__link">
        Optimización
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5">
          Desarrollo
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Desarrollo" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Desarrollo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Empaquetado/" class="md-nav__link">
        Empaquetado
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Organización
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Organización
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduccion" class="md-nav__link">
    Introducción
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#editor" class="md-nav__link">
    Editor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
    <nav class="md-nav" aria-label="Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#readme" class="md-nav__link">
    README
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuraciones" class="md-nav__link">
    Configuraciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operaciones" class="md-nav__link">
    Operaciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilidades" class="md-nav__link">
    Utilidades
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proyecto" class="md-nav__link">
    Proyecto
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#principios" class="md-nav__link">
    Principios
  </a>
  
    <nav class="md-nav" aria-label="Principios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#envolver-la-funcionalidad-en-funciones" class="md-nav__link">
    Envolver la funcionalidad en funciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#componer-funciones-generalizadas" class="md-nav__link">
    Componer funciones generalizadas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data" class="md-nav__link">
    Data
  </a>
  
    <nav class="md-nav" aria-label="Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load" class="md-nav__link">
    Load
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preprocesamiento" class="md-nav__link">
    Preprocesamiento
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etiquetado" class="md-nav__link">
    Etiquetado
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#split" class="md-nav__link">
    Split
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelado" class="md-nav__link">
    Modelado
  </a>
  
    <nav class="md-nav" aria-label="Modelado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entrenamiento" class="md-nav__link">
    Entrenamiento
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimizacion" class="md-nav__link">
    Optimización
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seguimiento-de-experimentos" class="md-nav__link">
    Seguimiento de experimentos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prediccion" class="md-nav__link">
    Predicción
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Logging/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Documentaci%C3%B3n/" class="md-nav__link">
        Documentación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Estilismo/" class="md-nav__link">
        Estilismo
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Seguridad/" class="md-nav__link">
        Seguridad
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Makefile/" class="md-nav__link">
        Makefile
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6">
          Inferencia
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Inferencia" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Inferencia
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Inferencia/L%C3%ADnea%20de%20comando/" class="md-nav__link">
        Línea de comando
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Inferencia/API%20RESTful/" class="md-nav__link">
        API RESTful
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7">
          Testing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Testing" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Testing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Pruebas/Testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Pruebas/C%C3%B3digo/" class="md-nav__link">
        Código
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Pruebas/Datos/" class="md-nav__link">
        Datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Pruebas/Modelos/" class="md-nav__link">
        Modelos
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8">
          Reproducibilidad
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reproducibilidad" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Reproducibilidad
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Reproducibilidad/Git/" class="md-nav__link">
        Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Reproducibilidad/Pre-commit/" class="md-nav__link">
        Pre-commit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Reproducibilidad/Versionado/" class="md-nav__link">
        Versionado
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Reproducibilidad/Docker/" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_9">
          Producción
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Producción" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Producción
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Producci%C3%B3n/Dashboard/" class="md-nav__link">
        Dashboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Producci%C3%B3n/CI-CD/" class="md-nav__link">
        CI-CD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Producci%C3%B3n/Monitoreo/" class="md-nav__link">
        Monitoreo
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Producci%C3%B3n/Dise%C3%B1o%20de%20sistemas/" class="md-nav__link">
        Diseño de sistemas
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_10">
          Ingeniería de datos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ingeniería de datos" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Ingeniería de datos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Ingenier%C3%ADa%20de%20datos/Data%20stack/" class="md-nav__link">
        Data stack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Ingenier%C3%ADa%20de%20datos/Orquestaci%C3%B3n/" class="md-nav__link">
        Orquestación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Ingenier%C3%ADa%20de%20datos/Feature%20store/" class="md-nav__link">
        Feature store
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduccion" class="md-nav__link">
    Introducción
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#editor" class="md-nav__link">
    Editor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
    <nav class="md-nav" aria-label="Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#readme" class="md-nav__link">
    README
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuraciones" class="md-nav__link">
    Configuraciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operaciones" class="md-nav__link">
    Operaciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilidades" class="md-nav__link">
    Utilidades
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proyecto" class="md-nav__link">
    Proyecto
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#principios" class="md-nav__link">
    Principios
  </a>
  
    <nav class="md-nav" aria-label="Principios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#envolver-la-funcionalidad-en-funciones" class="md-nav__link">
    Envolver la funcionalidad en funciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#componer-funciones-generalizadas" class="md-nav__link">
    Componer funciones generalizadas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data" class="md-nav__link">
    Data
  </a>
  
    <nav class="md-nav" aria-label="Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load" class="md-nav__link">
    Load
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preprocesamiento" class="md-nav__link">
    Preprocesamiento
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etiquetado" class="md-nav__link">
    Etiquetado
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#split" class="md-nav__link">
    Split
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelado" class="md-nav__link">
    Modelado
  </a>
  
    <nav class="md-nav" aria-label="Modelado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entrenamiento" class="md-nav__link">
    Entrenamiento
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimizacion" class="md-nav__link">
    Optimización
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seguimiento-de-experimentos" class="md-nav__link">
    Seguimiento de experimentos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prediccion" class="md-nav__link">
    Predicción
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="organizacion-del-codigo-de-machine-learning">Organización del código de Machine Learning</h1>
<p>Organizar el código al pasar de notebooks a scripts de Python.</p>
<h2 id="introduccion">Introducción</h2>
<p>Tener un código organizado es tener un código legible, reproducible y robusto. Tu equipo y, también tu yo futuro, te agradecerán por hacer el esfuerzo inicial para organizar el trabajo.
Veremos cómo migrar y organizar el código de nuestro notebook a scripts de Python.</p>
<h2 id="editor">Editor</h2>
<p>Hay varias opciones para los editores de código, como VSCode, Atom, Sublime, PyCharm, Vim, etc.
y todos ofrecen funciones únicas al tiempo que proporcionan las operaciones básicas para la edición y ejecución de código.
Usaremos VSCode para editar y ejecutar nuestro código gracias a su simplicidad, soporte multilingüe, complementos y creciente adopción en la industria.</p>
<ol>
<li>En Visual Studio Code abra la paleta de comandos (CTRL + SHIFT + P) y escriba "Preferences: Open Settings (UI)" y presione Enter.</li>
<li>Ajuste cualquier configuración relevante que desee (espaciado, tamaño de fuente, etc.)</li>
<li>Instale <a href="https://marketplace.visualstudio.com/">extensiones de VSCode</a> (utilice el ícono de bloques de lego en el panel izquierdo del editor)</li>
</ol>
<details>
<summary>Extensiones VSCode recomendadas</summary>

Recomendamos instalar estas extensiones:

<div class="highlight"><pre><span></span><code>code --install-extension alefragnani.project-manager
code --install-extension bierner.markdown-preview-github-styles
code --install-extension christian-kohler.path-intellisense
code --install-extension euskadi31.json-pretty-printer
code --install-extension mechatroner.rainbow-csv
code --install-extension mikestead.dotenv
code --install-extension ms-azuretools.vscode-docker
code --install-extension ms-python.python
code --install-extension ms-python.vscode-pylance
code --install-extension njpwerner.autodocstring
code --install-extension PKief.material-icon-theme
code --install-extension redhat.vscode-yaml
code --install-extension shardulm94.trailing-spaces
code --install-extension streetsidesoftware.code-spell-checker-spanish
code --install-extension DavidAnson.vscode-markdownlint
code --install-extension donjayamanne.python-environment-manager
code --install-extension donjayamanne.python-extension-pack
code --install-extension equinusocio.vsc-material-theme-icons
code --install-extension etmoffat.pip-packages
code --install-extension KevinRose.vsc-python-indent
code --install-extension magicstack.MagicPython
code --install-extension mdickin.markdown-shortcuts
code --install-extension ms-azure-devops.azure-pipelines
code --install-extension ms-azuretools.vscode-azureappservice
code --install-extension ms-azuretools.vscode-azurefunctions
code --install-extension ms-azuretools.vscode-azureresourcegroups
code --install-extension ms-azuretools.vscode-azurestaticwebapps
code --install-extension ms-azuretools.vscode-azurestorage
code --install-extension ms-azuretools.vscode-azurevirtualmachines
code --install-extension ms-azuretools.vscode-bicep
code --install-extension ms-azuretools.vscode-cosmosdb
code --install-extension ms-python.isort
code --install-extension ms-toolsai.jupyter
code --install-extension ms-toolsai.jupyter-keymap
code --install-extension ms-toolsai.jupyter-renderers
code --install-extension ms-toolsai.vscode-ai
code --install-extension ms-toolsai.vscode-ai-remote
code --install-extension ms-toolsai.vscode-jupyter-cell-tags
code --install-extension ms-toolsai.vscode-jupyter-slideshow
code --install-extension ms-vscode-remote.remote-containers
code --install-extension ms-vscode-remote.remote-wsl
code --install-extension ms-vscode.azure-account
code --install-extension ms-vscode.azurecli
code --install-extension ms-vscode.powershell
code --install-extension ms-vscode.vscode-node-azure-pack
code --install-extension msazurermtools.azurerm-vscode-tools
code --install-extension VisualStudioExptTeam.vscodeintellicode
code --install-extension vscode-icons-team.vscode-icons
code --install-extension yzhang.markdown-all-in-one
</code></pre></div>

Si agrega sus propias extensiones y desea compartirlas con otros, simplemente ejecute este comando para generar la lista de comandos:

<div class="highlight"><pre><span></span><code>code --list-extensions <span class="p">|</span> xargs -L <span class="m">1</span> <span class="nb">echo</span> code --install-extension
</code></pre></div>

</details>

<p>Luego de configurar VSCode, podemos comenzar creando nuestro directorio de proyectos, que usaremos para organizar todos nuestros scripts.
Hay muchas maneras de iniciar un proyecto, pero esta es nuestra ruta recomendada:</p>
<ol>
<li>Utilice la terminal para crear un directorio (<code>mkdir &lt;NOMBRE_PROYECTO&gt;</code>).</li>
<li>Cambie al directorio del proyecto que acaba de crear (<code>cd &lt;PROJECT_NAME&gt;</code>).</li>
<li>Inicie VSCode desde este directorio escribiendo el <code>code .</code></li>
<li>Abra una terminal dentro de VSCode (<code>View &gt; Terminal</code>) para continuar creando scripts (<code>touch &lt;NOMBRE_DE_ARCHIVO&gt;</code>) o subdirectorios adicionales (<code>mkdir &lt;SUBDIR&gt;</code>) según sea necesario.</li>
</ol>
<h2 id="setup">Setup</h2>
<h3 id="readme">README</h3>
<p>Comenzaremos nuestra organización con un archivo README.md, que proporcionará información sobre los archivos en nuestro directorio, instrucciones para ejecutar operaciones, etc.
Mantendremos constantemente actualizado este archivo para que podamos catalogar información para el futuro.</p>
<div class="highlight"><pre><span></span><code>touch README.md
</code></pre></div>
<p>Comencemos agregando las instrucciones que usamos para crear un virtual environment:</p>
<div class="highlight"><pre><span></span><code><span class="gh"># CoE MLOps Template</span>

<span class="gu">## Virtual environment</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>python3 -m venv venv
<span class="nb">source</span> ./venv/scripts/activate
python -m pip install --upgrade pip setuptools wheel
pip install -e .
</code></pre></div>
<h3 id="configuraciones">Configuraciones</h3>
<p>A continuación, crearemos un directorio de configuración llamado <code>config</code> donde podemos almacenar los componentes que serán necesarios para nuestra aplicación.
Dentro de este directorio, crearemos un <code>config.py</code> y un <code>args.json</code>.</p>
<div class="highlight"><pre><span></span><code>mkdir config
touch config/config.py config/args.json
</code></pre></div>
<p>Dentro de <code>config.py</code>, agregaremos el código para definir las ubicaciones clave del directorio (agregaremos más configuraciones a medida que sean necesarias):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># config.py</span>
from pathlib import Path

<span class="c1"># Directorios</span>
<span class="nv">BASE_DIR</span> <span class="o">=</span> Path<span class="o">(</span>__file__<span class="o">)</span>.parent.parent.absolute<span class="o">()</span>
<span class="nv">CONFIG_DIR</span> <span class="o">=</span> Path<span class="o">(</span>BASE_DIR, <span class="s2">&quot;config&quot;</span><span class="o">)</span>
</code></pre></div>
<p>y dentro de <code>args.json</code>, agregaremos los parámetros que son relevantes para el procesamiento de datos y el entrenamiento del modelo.</p>
<div class="highlight"><pre><span></span><code><span class="o">{</span>
    <span class="s2">&quot;shuffle&quot;</span>: true,
    <span class="s2">&quot;subset&quot;</span>: null,
    <span class="s2">&quot;min_freq&quot;</span>: <span class="m">75</span>,
    <span class="s2">&quot;lower&quot;</span>: true,
    <span class="s2">&quot;stem&quot;</span>: false,
    <span class="s2">&quot;analyzer&quot;</span>: <span class="s2">&quot;char&quot;</span>,
    <span class="s2">&quot;ngram_max_range&quot;</span>: <span class="m">7</span>,
    <span class="s2">&quot;alpha&quot;</span>: 1e-4,
    <span class="s2">&quot;learning_rate&quot;</span>: 1e-1,
    <span class="s2">&quot;power_t&quot;</span>: <span class="m">0</span>.1,
    <span class="s2">&quot;num_epochs&quot;</span>: <span class="m">100</span>
<span class="o">}</span>
</code></pre></div>
<h3 id="operaciones">Operaciones</h3>
<p>Comenzaremos creando nuestro directorio de paquetes (<code>src</code>) dentro de nuestro directorio de proyectos (<code>mlops</code>).
Dentro de este directorio de paquetes, crearemos un archivo <code>main.py</code> que definirá las operaciones principales que queremos tener disponibles.</p>
<div class="highlight"><pre><span></span><code>mkdir src
touch src/main.py
</code></pre></div>
<p>Definiremos estas operaciones centrales dentro de <code>main.py</code> a medida que movemos el código de los notebooks a los scripts apropiados a continuación:</p>
<ul>
<li><code>elt_data</code>: extrae, carga y transforma datos.</li>
<li><code>optimize</code>: ajustar los hiperparámetros para optimizar para el objetivo.</li>
<li><code>train_model</code>: entrena un modelo utilizando los mejores parámetros del estudio de optimización.</li>
<li><code>load_artifacts</code>: carga artefactos entrenados de una ejecución determinada.</li>
<li><code>predict_tag</code>: predecir una etiqueta para una entrada determinada.</li>
</ul>
<h3 id="utilidades">Utilidades</h3>
<p>Es común tener procesos ad-hoc dentro de los notebooks porque mantiene el estado siempre que el notebook se esté ejecutando.
Por ejemplo, podemos establecer seeds en nuestros notebooks así:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Setear seeds</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</code></pre></div>
<p>Pero en nuestros scripts, debemos envolver esta funcionalidad como una función limpia y reutilizable con los parámetros apropiados:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">set_seeds</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setear seeds para la reproducibilidad.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</code></pre></div>
<p>Podemos almacenar todas estas funciones dentro de un archivo <code>Utils.py</code> en el directorio de paquetes <code>src</code>.</p>
<div class="highlight"><pre><span></span><code>touch src/utils.py
</code></pre></div>
<details>
<summary>Ver utils.py</summary>

<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>


<span class="k">def</span> <span class="nf">load_dict</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cargar un diccionario desde la ruta de archivo de un JSON.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="k">def</span> <span class="nf">save_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sortkeys</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Guardar un diccionario en una ubicación específica.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fp</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="n">sortkeys</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">set_seeds</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setear seeds para la reproducibilidad.&quot;&quot;&quot;</span>
    <span class="c1"># Set seeds</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</code></pre></div>

</details>

<h2 id="proyecto">Proyecto</h2>
<p>Cuando se trata de migrar nuestro código de notebooks a scripts, es mejor organizarse en función de la utilidad.
Por ejemplo, podemos crear scripts para las diversas etapas del desarrollo de ML, como procesamiento de datos, entrenamiento, evaluación, predicción, etc.
Crearemos los diferentes archivos de Python para envolver nuestros datos y funcionalidad ML:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> src
touch data.py train.py evaluate.py predict.py
</code></pre></div>
<p>Es posible que tengamos scripts adicionales en otros proyectos, ya que son necesarios. Por ejemplo, normalmente tendríamos un script modelos.py.
Organizar nuestra base de código de esta manera también nos hace más fácil comprender (o modificar) la base de código.
Podríamos haber colocado todo el código en un script main.py, pero a medida que nuestro proyecto crezca, será difícil navegar por un archivo monolítico.
Por otro lado, podríamos haber asumido una postura más granular descomponiendo datos.py en split.py, preprocess.py, etc.
Esto podría tener más sentido si tenemos múltiples formas de dividir, preprocesamiento, etc. Pero en general, es suficiente estar en este nivel más alto de organización.</p>
<h2 id="principios">Principios</h2>
<p>A través del proceso de migración utilizaremos varios principios básicos de ingeniería de software repetidamente:</p>
<h3 id="envolver-la-funcionalidad-en-funciones">Envolver la funcionalidad en funciones</h3>
<p>¿Cómo decidimos cuándo deben envolver líneas de código específicas como una función separada?
Las funciones deben ser atómicas porque cada una tiene una sola responsabilidad para que podamos probarlas fácilmente.
Si no, necesitaremos dividirlos en unidades más granulares. Por ejemplo, podríamos reemplazar las etiquetas en nuestros proyectos con estas líneas:</p>
<div class="highlight"><pre><span></span><code><span class="n">oos_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
<span class="n">df</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">oos_tags</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div>
<p>Refactorizado quedaría así:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">replace_oos_tags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">tags_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reemplazar etiquetas fuera de alcance (oos).&quot;&quot;&quot;</span>
    <span class="n">oos_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">oos_tags</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>
<h3 id="componer-funciones-generalizadas">Componer funciones generalizadas</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">replace_oos_tags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">tags_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reemplazar etiquetas fuera de alcance (oos).&quot;&quot;&quot;</span>
    <span class="n">oos_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">oos_tags</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>
<p>Versus:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">replace_oos_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">label_col</span><span class="p">,</span> <span class="n">oos_label</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reemplazar etiquetas fuera de alcance (oos).&quot;&quot;&quot;</span>
    <span class="n">oos_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">oos_label</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">oos_tags</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>
<p>De esta manera, cuando cambian los nombres de las columnas o queremos reemplazar con diferentes etiquetas, es muy fácil ajustar nuestro código.
Esto también incluye el uso de nombres generalizados en las funciones como la etiqueta en lugar del nombre de la columna de etiqueta específica.
También permite a otros reutilizar esta funcionalidad para sus casos de uso.</p>
<h2 id="data">Data</h2>
<h3 id="load">Load</h3>
<details>
<summary>Cargar y guardar datos</summary>

Primero, nombraremos y crearemos el directorio para guardar nuestros activos de datos

<div class="highlight"><pre><span></span><code><span class="c1"># config/config.py</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Directorios</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
<span class="n">CONFIG_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>

<span class="c1"># Crear carpeta</span>
<span class="n">DATA_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

A continuación, agregaremos la ubicación de nuestros activos de datos sin procesar a nuestro `config.py`.
Es importante que almacenemos esta información en nuestro archivo de configuración central para que podamos descubrirlo y actualizarla fácilmente.

<div class="highlight"><pre><span></span><code><span class="c1"># config/config.py</span>
<span class="o">...</span>
<span class="c1"># Activos</span>
<span class="n">PROJECTS_URL</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/GokuMohandas/Made-With-ML/main/datasets/projects.csv&quot;</span>
<span class="n">TAGS_URL</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/GokuMohandas/Made-With-ML/main/datasets/tags.csv&quot;</span>
</code></pre></div>

Definiremos esta operación en `main.py`:

<div class="highlight"><pre><span></span><code><span class="c1"># src/main.py</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">elt_data</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Extraer, cargar y transformar nuestros activos de datos.&quot;&quot;&quot;</span>
    <span class="c1"># Extract + Load</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">PROJECTS_URL</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">TAGS_URL</span><span class="p">)</span>
    <span class="n">projects</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;projects.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">tags</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;tags.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Transform</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">projects</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>  <span class="c1"># eliminamos filas sin tags</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;labeled_projects.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Datos guardados!&quot;</span><span class="p">)</span>
</code></pre></div>

Debemos asegurarnos de tener los paquetes necesarios cargados en nuestro entorno.
Cargamos los paquetes requeridos y los agregemos a nuestro archivo `requirements.txt`:

<div class="highlight"><pre><span></span><code>python -m pip install <span class="nv">numpy</span><span class="o">==</span><span class="m">1</span>.19.5 <span class="nv">pandas</span><span class="o">==</span><span class="m">1</span>.3.5 pretty-errors<span class="o">==</span><span class="m">1</span>.2.19
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Agregar a requirements.txt</span>
<span class="nv">numpy</span><span class="o">==</span><span class="m">1</span>.19.5
<span class="nv">pandas</span><span class="o">==</span><span class="m">1</span>.3.5
pretty-errors<span class="o">==</span><span class="m">1</span>.2.19
</code></pre></div>

Ejecutaremos la operación utilizando el intérprete de Python a través del terminal (escriba `python` en la terminal y luego los comandos a continuación).

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">main</span>
<span class="n">main</span><span class="o">.</span><span class="n">elt_data</span><span class="p">()</span>
</code></pre></div>

</details>

<h3 id="preprocesamiento">Preprocesamiento</h3>
<details>
<summary>Preprocesamiento de features</summary>

A continuación, definiremos las funciones para preprocesar nuestros features de entrada.
Usaremos estas funciones cuando estemos preparando los datos antes de entrenar nuestro modelo.
No guardaremos los datos preprocesados en un archivo porque diferentes experimentos pueden preprocesarlos de manera diferente.

<div class="highlight"><pre><span></span><code><span class="c1"># src/data.py</span>
<span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">stem</span><span class="p">,</span> <span class="n">min_freq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Preprocesar los datos.&quot;&quot;&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">description</span>  <span class="c1"># feature engineering</span>
    <span class="n">df</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_text</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">stem</span><span class="o">=</span><span class="n">stem</span><span class="p">)</span>  <span class="c1"># limpiar texto</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">replace_oos_labels</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ACCEPTED_TAGS</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="n">oos_label</span><span class="o">=</span><span class="s2">&quot;other&quot;</span>
    <span class="p">)</span>  <span class="c1"># reemplazar etiquetas OOS</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">replace_minority_labels</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="n">min_freq</span><span class="p">,</span> <span class="n">new_label</span><span class="o">=</span><span class="s2">&quot;other&quot;</span>
    <span class="p">)</span>  <span class="c1"># reemplazar las etiquetas por debajo de la frecuencia mínima</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>

Esta función usa la función `clean_text()`:

<div class="highlight"><pre><span></span><code><span class="c1"># src/data.py</span>
<span class="kn">from</span> <span class="nn">nltk.stem</span> <span class="kn">import</span> <span class="n">PorterStemmer</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stem</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stopwords</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">STOPWORDS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Limpiar texto sin procesar.&quot;&quot;&quot;</span>
    <span class="c1"># Lower</span>
    <span class="k">if</span> <span class="n">lower</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Remover stopwords</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stopwords</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b(&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stopwords</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\b\s*&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="c1"># Espaciado y filtros</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;([!</span><span class="se">\&quot;</span><span class="s2">&#39;#$%&amp;()*\+,-./:;&lt;=&gt;?@</span><span class="se">\\</span><span class="s2">\[\]^_`{|}~])&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot; \1 &quot;</span><span class="p">,</span> <span class="n">text</span>
    <span class="p">)</span>  <span class="c1"># añadir espacio entre los objetos a filtrar</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^A-Za-z0-9]+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># eliminar caracteres no alfanuméricos</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; +&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># eliminar múltiples espacios</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># eliminar espacios en blanco en los extremos</span>

    <span class="c1"># Quitar links</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;http\S+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="c1"># Stemming</span>
    <span class="k">if</span> <span class="n">stem</span><span class="p">:</span>
        <span class="n">stemmer</span> <span class="o">=</span> <span class="n">PorterStemmer</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">stemmer</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">to_lowercase</span><span class="o">=</span><span class="n">lower</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>

Instale los paquetes requeridos y agréguelos a `requirements.txt`:

<div class="highlight"><pre><span></span><code>python -m pip install <span class="nv">nltk</span><span class="o">==</span><span class="m">3</span>.7
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Agregar a requirements.txt</span>
<span class="nv">nltk</span><span class="o">==</span><span class="m">3</span>.7
</code></pre></div>

Tenga en cuenta que estamos usando un conjunto explícito de stopwords en lugar de la lista predeterminada de NLTK.
Esto se debe a que queremos tener una visibilidad completa de exactamente qué palabras estamos filtrando.
La lista general puede tener algunos términos valiosos que deseamos conservar y viceversa.
También agregamos la lista de tags permitidos.

<div class="highlight"><pre><span></span><code><span class="c1"># config/config.py</span>
<span class="n">ACCEPTED_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;natural-language-processing&quot;</span><span class="p">,</span> <span class="s2">&quot;computer-vision&quot;</span><span class="p">,</span> <span class="s2">&quot;mlops&quot;</span><span class="p">,</span> <span class="s2">&quot;graph-learning&quot;</span><span class="p">]</span>
<span class="n">STOPWORDS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;i&quot;</span><span class="p">,</span>
    <span class="s2">&quot;me&quot;</span><span class="p">,</span>
    <span class="s2">&quot;my&quot;</span><span class="p">,</span>
    <span class="s2">&quot;myself&quot;</span><span class="p">,</span>
    <span class="s2">&quot;we&quot;</span><span class="p">,</span>
    <span class="s2">&quot;our&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ours&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ourselves&quot;</span><span class="p">,</span>
    <span class="s2">&quot;you&quot;</span><span class="p">,</span>
    <span class="s2">&quot;you&#39;re&quot;</span><span class="p">,</span>
    <span class="s2">&quot;you&#39;ve&quot;</span><span class="p">,</span>
    <span class="s2">&quot;you&#39;ll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;you&#39;d&quot;</span><span class="p">,</span>
    <span class="s2">&quot;your&quot;</span><span class="p">,</span>
    <span class="s2">&quot;yours&quot;</span><span class="p">,</span>
    <span class="s2">&quot;yourself&quot;</span><span class="p">,</span>
    <span class="s2">&quot;yourselves&quot;</span><span class="p">,</span>
    <span class="s2">&quot;he&quot;</span><span class="p">,</span>
    <span class="s2">&quot;him&quot;</span><span class="p">,</span>
    <span class="s2">&quot;his&quot;</span><span class="p">,</span>
    <span class="s2">&quot;himself&quot;</span><span class="p">,</span>
    <span class="s2">&quot;she&quot;</span><span class="p">,</span>
    <span class="s2">&quot;she&#39;s&quot;</span><span class="p">,</span>
    <span class="s2">&quot;her&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hers&quot;</span><span class="p">,</span>
    <span class="s2">&quot;herself&quot;</span><span class="p">,</span>
    <span class="s2">&quot;it&quot;</span><span class="p">,</span>
    <span class="s2">&quot;it&#39;s&quot;</span><span class="p">,</span>
    <span class="s2">&quot;its&quot;</span><span class="p">,</span>
    <span class="s2">&quot;itself&quot;</span><span class="p">,</span>
    <span class="s2">&quot;they&quot;</span><span class="p">,</span>
    <span class="s2">&quot;them&quot;</span><span class="p">,</span>
    <span class="s2">&quot;their&quot;</span><span class="p">,</span>
    <span class="s2">&quot;theirs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;themselves&quot;</span><span class="p">,</span>
    <span class="s2">&quot;what&quot;</span><span class="p">,</span>
    <span class="s2">&quot;which&quot;</span><span class="p">,</span>
    <span class="s2">&quot;who&quot;</span><span class="p">,</span>
    <span class="s2">&quot;whom&quot;</span><span class="p">,</span>
    <span class="s2">&quot;this&quot;</span><span class="p">,</span>
    <span class="s2">&quot;that&quot;</span><span class="p">,</span>
    <span class="s2">&quot;that&#39;ll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;these&quot;</span><span class="p">,</span>
    <span class="s2">&quot;those&quot;</span><span class="p">,</span>
    <span class="s2">&quot;am&quot;</span><span class="p">,</span>
    <span class="s2">&quot;is&quot;</span><span class="p">,</span>
    <span class="s2">&quot;are&quot;</span><span class="p">,</span>
    <span class="s2">&quot;was&quot;</span><span class="p">,</span>
    <span class="s2">&quot;were&quot;</span><span class="p">,</span>
    <span class="s2">&quot;be&quot;</span><span class="p">,</span>
    <span class="s2">&quot;been&quot;</span><span class="p">,</span>
    <span class="s2">&quot;being&quot;</span><span class="p">,</span>
    <span class="s2">&quot;have&quot;</span><span class="p">,</span>
    <span class="s2">&quot;has&quot;</span><span class="p">,</span>
    <span class="s2">&quot;had&quot;</span><span class="p">,</span>
    <span class="s2">&quot;having&quot;</span><span class="p">,</span>
    <span class="s2">&quot;do&quot;</span><span class="p">,</span>
    <span class="s2">&quot;does&quot;</span><span class="p">,</span>
    <span class="s2">&quot;did&quot;</span><span class="p">,</span>
    <span class="s2">&quot;doing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;an&quot;</span><span class="p">,</span>
    <span class="s2">&quot;the&quot;</span><span class="p">,</span>
    <span class="s2">&quot;and&quot;</span><span class="p">,</span>
    <span class="s2">&quot;but&quot;</span><span class="p">,</span>
    <span class="s2">&quot;if&quot;</span><span class="p">,</span>
    <span class="s2">&quot;or&quot;</span><span class="p">,</span>
    <span class="s2">&quot;because&quot;</span><span class="p">,</span>
    <span class="s2">&quot;as&quot;</span><span class="p">,</span>
    <span class="s2">&quot;until&quot;</span><span class="p">,</span>
    <span class="s2">&quot;while&quot;</span><span class="p">,</span>
    <span class="s2">&quot;of&quot;</span><span class="p">,</span>
    <span class="s2">&quot;at&quot;</span><span class="p">,</span>
    <span class="s2">&quot;by&quot;</span><span class="p">,</span>
    <span class="s2">&quot;for&quot;</span><span class="p">,</span>
    <span class="s2">&quot;with&quot;</span><span class="p">,</span>
    <span class="s2">&quot;about&quot;</span><span class="p">,</span>
    <span class="s2">&quot;against&quot;</span><span class="p">,</span>
    <span class="s2">&quot;between&quot;</span><span class="p">,</span>
    <span class="s2">&quot;into&quot;</span><span class="p">,</span>
    <span class="s2">&quot;through&quot;</span><span class="p">,</span>
    <span class="s2">&quot;during&quot;</span><span class="p">,</span>
    <span class="s2">&quot;before&quot;</span><span class="p">,</span>
    <span class="s2">&quot;after&quot;</span><span class="p">,</span>
    <span class="s2">&quot;above&quot;</span><span class="p">,</span>
    <span class="s2">&quot;below&quot;</span><span class="p">,</span>
    <span class="s2">&quot;to&quot;</span><span class="p">,</span>
    <span class="s2">&quot;from&quot;</span><span class="p">,</span>
    <span class="s2">&quot;up&quot;</span><span class="p">,</span>
    <span class="s2">&quot;down&quot;</span><span class="p">,</span>
    <span class="s2">&quot;in&quot;</span><span class="p">,</span>
    <span class="s2">&quot;out&quot;</span><span class="p">,</span>
    <span class="s2">&quot;on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="s2">&quot;over&quot;</span><span class="p">,</span>
    <span class="s2">&quot;under&quot;</span><span class="p">,</span>
    <span class="s2">&quot;again&quot;</span><span class="p">,</span>
    <span class="s2">&quot;further&quot;</span><span class="p">,</span>
    <span class="s2">&quot;then&quot;</span><span class="p">,</span>
    <span class="s2">&quot;once&quot;</span><span class="p">,</span>
    <span class="s2">&quot;here&quot;</span><span class="p">,</span>
    <span class="s2">&quot;there&quot;</span><span class="p">,</span>
    <span class="s2">&quot;when&quot;</span><span class="p">,</span>
    <span class="s2">&quot;where&quot;</span><span class="p">,</span>
    <span class="s2">&quot;why&quot;</span><span class="p">,</span>
    <span class="s2">&quot;how&quot;</span><span class="p">,</span>
    <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="s2">&quot;any&quot;</span><span class="p">,</span>
    <span class="s2">&quot;both&quot;</span><span class="p">,</span>
    <span class="s2">&quot;each&quot;</span><span class="p">,</span>
    <span class="s2">&quot;few&quot;</span><span class="p">,</span>
    <span class="s2">&quot;more&quot;</span><span class="p">,</span>
    <span class="s2">&quot;most&quot;</span><span class="p">,</span>
    <span class="s2">&quot;other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;some&quot;</span><span class="p">,</span>
    <span class="s2">&quot;such&quot;</span><span class="p">,</span>
    <span class="s2">&quot;no&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;not&quot;</span><span class="p">,</span>
    <span class="s2">&quot;only&quot;</span><span class="p">,</span>
    <span class="s2">&quot;own&quot;</span><span class="p">,</span>
    <span class="s2">&quot;same&quot;</span><span class="p">,</span>
    <span class="s2">&quot;so&quot;</span><span class="p">,</span>
    <span class="s2">&quot;than&quot;</span><span class="p">,</span>
    <span class="s2">&quot;too&quot;</span><span class="p">,</span>
    <span class="s2">&quot;very&quot;</span><span class="p">,</span>
    <span class="s2">&quot;s&quot;</span><span class="p">,</span>
    <span class="s2">&quot;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;can&quot;</span><span class="p">,</span>
    <span class="s2">&quot;will&quot;</span><span class="p">,</span>
    <span class="s2">&quot;just&quot;</span><span class="p">,</span>
    <span class="s2">&quot;don&quot;</span><span class="p">,</span>
    <span class="s2">&quot;don&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;should&quot;</span><span class="p">,</span>
    <span class="s2">&quot;should&#39;ve&quot;</span><span class="p">,</span>
    <span class="s2">&quot;now&quot;</span><span class="p">,</span>
    <span class="s2">&quot;d&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;m&quot;</span><span class="p">,</span>
    <span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="s2">&quot;re&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ve&quot;</span><span class="p">,</span>
    <span class="s2">&quot;y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ain&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aren&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aren&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;couldn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;couldn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;didn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;didn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;doesn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;doesn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hadn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hadn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hasn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hasn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;haven&quot;</span><span class="p">,</span>
    <span class="s2">&quot;haven&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ma&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mightn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mightn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mustn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mustn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;needn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;needn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;shan&quot;</span><span class="p">,</span>
    <span class="s2">&quot;shan&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;shouldn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;shouldn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wasn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wasn&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;weren&quot;</span><span class="p">,</span>
    <span class="s2">&quot;weren&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;won&quot;</span><span class="p">,</span>
    <span class="s2">&quot;won&#39;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wouldn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wouldn&#39;t&quot;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>

A continuación, debemos definir las dos funciones a las que llamamos desde `data.py`:

<div class="highlight"><pre><span></span><code><span class="c1"># src/data.py</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>


<span class="k">def</span> <span class="nf">replace_oos_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">label_col</span><span class="p">,</span> <span class="n">oos_label</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reemplazar las etiquetas fuera de alcance (oos).&quot;&quot;&quot;</span>
    <span class="n">oos_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">oos_label</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">oos_tags</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">replace_minority_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_col</span><span class="p">,</span> <span class="n">min_freq</span><span class="p">,</span> <span class="n">new_label</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reemplazar las etiquetas minoritarias con otra etiqueta.&quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">labels_above_freq</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">elements</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_freq</span><span class="p">))</span>
    <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">label</span><span class="p">:</span> <span class="n">label</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels_above_freq</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">new_label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>

</details>

<h3 id="etiquetado">Etiquetado</h3>
<details>
<summary>Codificar etiquetas</summary>

Ahora definamos el codificador para nuestras etiquetas:

<div class="highlight"><pre><span></span><code><span class="c1"># src/data.py</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">class</span> <span class="nc">LabelEncoder</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Codificar las etiquetas en índices únicos.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_to_index</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_to_index</span> <span class="o">=</span> <span class="n">class_to_index</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># mutable defaults ;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_to_class</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_to_index</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_to_index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_to_index</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;LabelEncoder(num_classes=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">)&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">class_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_to_index</span><span class="p">[</span><span class="n">class_</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_to_class</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_to_index</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_to_index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">encoded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_to_index</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">encoded</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_to_class</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">classes</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;class_to_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_to_index</span><span class="p">}</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fp</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

</details>

<h3 id="split">Split</h3>
<details>
<summary>Split dataset</summary>

Y finalmente, concluiremos nuestras operaciones de datos con nuestra función de división:

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>


<span class="k">def</span> <span class="nf">get_data_splits</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generar divisiones de datos equilibradas.&quot;&quot;&quot;</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="n">train_size</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
    <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">X_</span><span class="p">,</span> <span class="n">y_</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span>
</code></pre></div>

Instale los paquetes requeridos y agréguelos a `requirements.txt`:

<div class="highlight"><pre><span></span><code>python -m pip install scikit-learn<span class="o">==</span><span class="m">0</span>.24.2
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Agregar a requirements.txt</span>
scikit-learn<span class="o">==</span><span class="m">0</span>.24.2
</code></pre></div>

</details>

<h2 id="modelado">Modelado</h2>
<h3 id="entrenamiento">Entrenamiento</h3>
<details>
<summary>Entrenar con argumentos predeterminados</summary>

Comenzaremos definiendo la operación en nuestro `main.py`:

<div class="highlight"><pre><span></span><code><span class="c1"># src/main.py</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>

<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">utils</span>


<span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">args_fp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Entrenar un modelo con argumentos dados.&quot;&quot;&quot;</span>
    <span class="c1"># Cargar datos etiquetados</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;labeled_projects.csv&quot;</span><span class="p">))</span>

    <span class="c1"># Entrenar</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="o">**</span><span class="n">utils</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">args_fp</span><span class="p">))</span>
    <span class="n">artifacts</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;performance&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">performance</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div>

Agregaremos más a nuestra operación `train_model()` cuando tengamos en cuenta el seguimiento de experimentos pero, por ahora, es bastante simple.

<div class="highlight"><pre><span></span><code><span class="c1"># src/train.py</span>
<span class="kn">from</span> <span class="nn">imblearn.over_sampling</span> <span class="kn">import</span> <span class="n">RandomOverSampler</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">SGDClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">log_loss</span>

<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">predict</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">evaluate</span>


<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">trial</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Entrenar modelo en datos.&quot;&quot;&quot;</span>

    <span class="c1"># Setup</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">set_seeds</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span> <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[:</span> <span class="n">args</span><span class="o">.</span><span class="n">subset</span><span class="p">]</span>  <span class="c1"># Ninguno = todas las muestras</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">stem</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">min_freq</span><span class="p">)</span>
    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> \
        <span class="n">data</span><span class="o">.</span><span class="n">get_data_splits</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tag</span><span class="p">))</span>
    <span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">,</span> <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">y_test</span><span class="p">)})</span>

    <span class="c1"># Tf-idf</span>
    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">analyzer</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">analyzer</span><span class="p">,</span> <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">ngram_max_range</span><span class="p">))</span>  <span class="c1"># char n-grams</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_val</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Oversample</span>
    <span class="n">oversample</span> <span class="o">=</span> <span class="n">RandomOverSampler</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="n">X_over</span><span class="p">,</span> <span class="n">y_over</span> <span class="o">=</span> <span class="n">oversample</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SGDClassifier</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="s2">&quot;l2&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">eta0</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">power_t</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">power_t</span><span class="p">,</span>
        <span class="n">warm_start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_over</span><span class="p">,</span> <span class="n">y_over</span><span class="p">)</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
        <span class="n">val_loss</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_val</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">epoch</span><span class="o">%</span><span class="mi">10</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2"> | &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;train_loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;val_loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Threshold</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
    <span class="n">y_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span>
        <span class="p">[</span><span class="n">y_prob</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)],</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>  <span class="c1"># Q1</span>

    <span class="c1"># Evaluacion</span>
    <span class="n">other_index</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">class_to_index</span><span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">]</span>
    <span class="n">y_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">predict</span><span class="o">.</span><span class="n">custom_predict</span><span class="p">(</span><span class="n">y_prob</span><span class="o">=</span><span class="n">y_prob</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">other_index</span><span class="p">)</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">(</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">test_df</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
        <span class="s2">&quot;label_encoder&quot;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="p">,</span>
        <span class="s2">&quot;vectorizer&quot;</span><span class="p">:</span> <span class="n">vectorizer</span><span class="p">,</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="s2">&quot;performance&quot;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>

Esta función `train()` llama a dos funciones externas (`predict.custom_predict()` de `predict.py` y `Evaluation.get_metrics()` de `Evaluation.py`):

<div class="highlight"><pre><span></span><code><span class="c1"># src/predict.py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">custom_predict</span><span class="p">(</span><span class="n">y_prob</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Función de predicción personalizada que por defecto</span>
<span class="sd">    es un índice si no se cumplen las condiciones.&quot;&quot;&quot;</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="n">index</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">y_prob</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># src/evaluate.py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">precision_recall_fscore_support</span>
<span class="kn">from</span> <span class="nn">snorkel.slicing</span> <span class="kn">import</span> <span class="n">PandasSFApplier</span>
<span class="kn">from</span> <span class="nn">snorkel.slicing</span> <span class="kn">import</span> <span class="n">slicing_function</span>


<span class="nd">@slicing_function</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">nlp_cnn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Proyectos de NLP que utilizan convolución.&quot;&quot;&quot;</span>
    <span class="n">nlp_projects</span> <span class="o">=</span> <span class="s2">&quot;natural-language-processing&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span>
    <span class="n">convolution_projects</span> <span class="o">=</span> <span class="s2">&quot;CNN&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;convolution&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">text</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">nlp_projects</span> <span class="ow">and</span> <span class="n">convolution_projects</span><span class="p">)</span>


<span class="nd">@slicing_function</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">short_text</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Proyectos con títulos y descripciones cortos.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">8</span>  <span class="c1"># menos de 8 palabras</span>


<span class="k">def</span> <span class="nf">get_slice_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">slices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generar métricas para segmentos de datos.&quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">slice_name</span> <span class="ow">in</span> <span class="n">slices</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">slices</span><span class="p">[</span><span class="n">slice_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">slice_metrics</span> <span class="o">=</span> <span class="n">precision_recall_fscore_support</span><span class="p">(</span>
                <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span>
            <span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">slice_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">slice_name</span><span class="p">][</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">slice_name</span><span class="p">][</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_metrics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">slice_name</span><span class="p">][</span><span class="s2">&quot;f1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_metrics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">slice_name</span><span class="p">][</span><span class="s2">&quot;num_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">metrics</span>


<span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Métricas de rendimiento utilizando verdades y predicciones.&quot;&quot;&quot;</span>
    <span class="c1"># Performance</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;overall&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="c1"># Métricas generales</span>
    <span class="n">overall_metrics</span> <span class="o">=</span> <span class="n">precision_recall_fscore_support</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_metrics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;f1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_metrics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;num_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span>

    <span class="c1"># Métricas por clase</span>
    <span class="n">class_metrics</span> <span class="o">=</span> <span class="n">precision_recall_fscore_support</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_class</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">][</span><span class="n">_class</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">class_metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;recall&quot;</span><span class="p">:</span> <span class="n">class_metrics</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;f1&quot;</span><span class="p">:</span> <span class="n">class_metrics</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;num_samples&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">class_metrics</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
        <span class="p">}</span>

    <span class="c1"># Métricas de secciones</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="n">PandasSFApplier</span><span class="p">([</span><span class="n">nlp_cnn</span><span class="p">,</span> <span class="n">short_text</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;slices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_slice_metrics</span><span class="p">(</span>
            <span class="n">y_true</span><span class="o">=</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="n">slices</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div>

Instale los paquetes requeridos y agréguelos a `requirements.txt`:

<div class="highlight"><pre><span></span><code>python -m pip install imbalanced-learn<span class="o">==</span><span class="m">0</span>.8.1 <span class="nv">snorkel</span><span class="o">==</span><span class="m">0</span>.9.8
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Agregar a requirements.txt</span>
imbalanced-learn<span class="o">==</span><span class="m">0</span>.8.1
<span class="nv">snorkel</span><span class="o">==</span><span class="m">0</span>.9.8
</code></pre></div>

Comandos para entrenar un modelo:

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">main</span>
<span class="n">args_fp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG_DIR</span><span class="p">,</span> <span class="s2">&quot;args.json&quot;</span><span class="p">)</span>
<span class="n">main</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">args_fp</span><span class="p">)</span>
</code></pre></div>

Puede ser que aparezca un mensaje como este:

<div class="highlight"><pre><span></span><code>TypeError: Descriptors cannot not be created directly.
If this call came from a _pb2.py file, your generated code is out of date and must be regenerated with protoc &gt;<span class="o">=</span> <span class="m">3</span>.19.0.
</code></pre></div>

Para solucionar este error hay que hacer un downgrade de protobuf:

<div class="highlight"><pre><span></span><code>python -m pip install <span class="nv">protobuf</span><span class="o">==</span><span class="m">3</span>.20.*
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Agregar a requirements.txt</span>
<span class="nv">protobuf</span><span class="o">==</span><span class="m">3</span>.20.*
</code></pre></div>

Luego vuelva a ejecutar los comandos para entrenar el modelo.

</details>

<h3 id="optimizacion">Optimización</h3>
<details>
<summary>Optimizar argumentos</summary>

Ahora que podemos entrenar un modelo, estamos listos para entrenar muchos modelos para optimizar nuestros hiperparámetros:

<div class="highlight"><pre><span></span><code><span class="c1"># src/main.py</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">numpyencoder</span> <span class="kn">import</span> <span class="n">NumpyEncoder</span>
<span class="kn">import</span> <span class="nn">optuna</span>
<span class="kn">from</span> <span class="nn">optuna.integration.mlflow</span> <span class="kn">import</span> <span class="n">MLflowCallback</span>


<span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="n">args_fp</span><span class="p">,</span> <span class="n">study_name</span><span class="p">,</span> <span class="n">num_trials</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Optimizar hiperparámetros.&quot;&quot;&quot;</span>
    <span class="c1"># Cargar datos etiquetados</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;labeled_projects.csv&quot;</span><span class="p">))</span>

    <span class="c1"># Optimizar</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="o">**</span><span class="n">utils</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">args_fp</span><span class="p">))</span>
    <span class="n">pruner</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">pruners</span><span class="o">.</span><span class="n">MedianPruner</span><span class="p">(</span><span class="n">n_startup_trials</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_warmup_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">study_name</span><span class="o">=</span><span class="s2">&quot;optimization&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;maximize&quot;</span><span class="p">,</span> <span class="n">pruner</span><span class="o">=</span><span class="n">pruner</span><span class="p">)</span>
    <span class="n">mlflow_callback</span> <span class="o">=</span> <span class="n">MLflowCallback</span><span class="p">(</span>
        <span class="n">tracking_uri</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">get_tracking_uri</span><span class="p">(),</span> <span class="n">metric_name</span><span class="o">=</span><span class="s2">&quot;f1&quot;</span><span class="p">)</span>
    <span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">trial</span><span class="p">:</span> <span class="n">train</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">trial</span><span class="p">),</span>
        <span class="n">n_trials</span><span class="o">=</span><span class="n">num_trials</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">mlflow_callback</span><span class="p">])</span>

    <span class="c1"># Mejor prueba</span>
    <span class="n">trials_df</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">trials_dataframe</span><span class="p">()</span>
    <span class="n">trials_df</span> <span class="o">=</span> <span class="n">trials_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;user_attrs_f1&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">save_dict</span><span class="p">({</span><span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="o">**</span><span class="n">study</span><span class="o">.</span><span class="n">best_trial</span><span class="o">.</span><span class="n">params</span><span class="p">},</span> <span class="n">args_fp</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">NumpyEncoder</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor valor (f1): </span><span class="si">{</span><span class="n">study</span><span class="o">.</span><span class="n">best_trial</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores hiperparámetros: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">study</span><span class="o">.</span><span class="n">best_trial</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

Definiremos la función `objective()` dentro de `train.py`:

<div class="highlight"><pre><span></span><code><span class="c1"># src/train.py</span>
<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">trial</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Función objetivo para pruebas de optimización.&quot;&quot;&quot;</span>
    <span class="c1"># Parámetros a tunear</span>
    <span class="n">args</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s2">&quot;analyzer&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">,</span> <span class="s2">&quot;char_wb&quot;</span><span class="p">])</span>
    <span class="n">args</span><span class="o">.</span><span class="n">ngram_max_range</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">&quot;ngram_max_range&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_loguniform</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">power_t</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_uniform</span><span class="p">(</span><span class="s2">&quot;power_t&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Entrenar &amp; evaluatar</span>
    <span class="n">artifacts</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">trial</span><span class="o">=</span><span class="n">trial</span><span class="p">)</span>

    <span class="c1"># Establecer atributos adicionales</span>
    <span class="n">overall_performance</span> <span class="o">=</span> <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;performance&quot;</span><span class="p">][</span><span class="s2">&quot;overall&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">overall_performance</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">trial</span><span class="o">.</span><span class="n">set_user_attr</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="n">overall_performance</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">])</span>
    <span class="n">trial</span><span class="o">.</span><span class="n">set_user_attr</span><span class="p">(</span><span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="n">overall_performance</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">])</span>
    <span class="n">trial</span><span class="o">.</span><span class="n">set_user_attr</span><span class="p">(</span><span class="s2">&quot;f1&quot;</span><span class="p">,</span> <span class="n">overall_performance</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">overall_performance</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">]</span>
</code></pre></div>

Recuerde que en nuestro notebook modificamos la función `train()` para incluir información sobre las pruebas durante la optimización para pruning:

<div class="highlight"><pre><span></span><code><span class="c1"># src/train.py</span>
<span class="kn">import</span> <span class="nn">optuna</span>


<span class="k">def</span> <span class="nf">train</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="c1"># Entrenamiento</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="c1"># Pruning (para optimización en la siguiente sección)</span>
        <span class="k">if</span> <span class="n">trial</span><span class="p">:</span>
            <span class="n">trial</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">val_loss</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">optuna</span><span class="o">.</span><span class="n">TrialPruned</span><span class="p">()</span>
</code></pre></div>

Dado que estamos usando `MLflowCallback` aquí con Optuna, podemos permitir que todos nuestros experimentos se almacenen en el directorio `mlruns` predeterminado
que creará MLflow o podemos configurar esa ubicación:

<div class="highlight"><pre><span></span><code><span class="c1"># config/config.py</span>
<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="c1"># Directorios</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
<span class="n">CONFIG_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
<span class="n">STORES_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;stores&quot;</span><span class="p">)</span>

<span class="c1"># Stores</span>
<span class="n">MODEL_REGISTRY</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">STORES_DIR</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>

<span class="c1"># Crear carpetas</span>
<span class="n">DATA_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">MODEL_REGISTRY</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Registro del modelo MLFlow</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;file:</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">MODEL_REGISTRY</span><span class="o">.</span><span class="n">absolute</span><span class="p">()))</span>
</code></pre></div>

Instale los paquetes requeridos y agréguelos a `requirements.txt`:

<div class="highlight"><pre><span></span><code>python -m pip install <span class="nv">mlflow</span><span class="o">==</span><span class="m">1</span>.23.1 <span class="nv">optuna</span><span class="o">==</span><span class="m">2</span>.10.0 <span class="nv">numpyencoder</span><span class="o">==</span><span class="m">0</span>.3.0
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># Agregar a requirements.txt</span>
<span class="nv">mlflow</span><span class="o">==</span><span class="m">1</span>.23.1
<span class="nv">numpyencoder</span><span class="o">==</span><span class="m">0</span>.3.0
<span class="nv">optuna</span><span class="o">==</span><span class="m">2</span>.10.0
</code></pre></div>

Comandos para optimizar hiperparámetros:

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">main</span>
<span class="n">args_fp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG_DIR</span><span class="p">,</span> <span class="s2">&quot;args.json&quot;</span><span class="p">)</span>
<span class="n">main</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">args_fp</span><span class="p">,</span> <span class="n">study_name</span><span class="o">=</span><span class="s2">&quot;optimization&quot;</span><span class="p">,</span> <span class="n">num_trials</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div>

</details>

<h3 id="seguimiento-de-experimentos">Seguimiento de experimentos</h3>
<details>
<summary>Seguimiento de experimentos</summary>

Ahora que tenemos nuestros hiperparámetros optimizados, podemos entrenar un modelo y almacenar sus artefactos a través del seguimiento de experimentos.
Comenzaremos modificando la operación `train()` en nuestro script `main.py`:

<div class="highlight"><pre><span></span><code><span class="c1"># src/main.py</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">tempfile</span>


<span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">args_fp</span><span class="p">,</span> <span class="n">experiment_name</span><span class="p">,</span> <span class="n">run_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Entrenar un modelo con argumentos dados.&quot;&quot;&quot;</span>
    <span class="c1"># Cargar datos etiquetados</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;labeled_projects.csv&quot;</span><span class="p">))</span>

    <span class="c1"># Entrenar</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="o">**</span><span class="n">utils</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">args_fp</span><span class="p">))</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="n">experiment_name</span><span class="o">=</span><span class="n">experiment_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">):</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run ID: </span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;performance&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">performance</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Logeo de métricas y parámetros</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;performance&quot;</span><span class="p">]</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">({</span><span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">performance</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;precision&quot;</span><span class="p">]})</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">({</span><span class="s2">&quot;recall&quot;</span><span class="p">:</span> <span class="n">performance</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;recall&quot;</span><span class="p">]})</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">({</span><span class="s2">&quot;f1&quot;</span><span class="p">:</span> <span class="n">performance</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;f1&quot;</span><span class="p">]})</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]))</span>

        <span class="c1"># Logeo de artifacts</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">dp</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">save_dict</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]),</span> <span class="n">Path</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s2">&quot;args.json&quot;</span><span class="p">),</span> <span class="bp">cls</span><span class="o">=</span><span class="n">NumpyEncoder</span><span class="p">)</span>
            <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;label_encoder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s2">&quot;label_encoder.json&quot;</span><span class="p">))</span>
            <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;vectorizer&quot;</span><span class="p">],</span> <span class="n">Path</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s2">&quot;vectorizer.pkl&quot;</span><span class="p">))</span>
            <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span> <span class="n">Path</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s2">&quot;model.pkl&quot;</span><span class="p">))</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">save_dict</span><span class="p">(</span><span class="n">performance</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s2">&quot;performance.json&quot;</span><span class="p">))</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifacts</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>

    <span class="c1"># Guardar en config</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG_DIR</span><span class="p">,</span> <span class="s2">&quot;run_id.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">save_dict</span><span class="p">(</span><span class="n">performance</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG_DIR</span><span class="p">,</span> <span class="s2">&quot;performance.json&quot;</span><span class="p">))</span>
</code></pre></div>

También vamos a actualizar la función `train()` dentro de `train.py` para que se capturen las métricas intermedias:

<div class="highlight"><pre><span></span><code><span class="c1"># src/train.py</span>
<span class="kn">import</span> <span class="nn">mlflow</span>


<span class="k">def</span> <span class="nf">train</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="c1"># Training</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="c1"># Log</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trial</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">({</span><span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">,</span> <span class="s2">&quot;val_loss&quot;</span><span class="p">:</span> <span class="n">val_loss</span><span class="p">},</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
</code></pre></div>

Comandos para entrenar un modelo con seguimiento de experimentos:

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">main</span>
<span class="n">args_fp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG_DIR</span><span class="p">,</span> <span class="s2">&quot;args.json&quot;</span><span class="p">)</span>
<span class="n">main</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">args_fp</span><span class="p">,</span> <span class="n">experiment_name</span><span class="o">=</span><span class="s2">&quot;baselines&quot;</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;sgd&quot;</span><span class="p">)</span>
</code></pre></div>

Nuestro directorio de configuración ahora debería tener un archivo performance.json y un archivo run_id.txt.
Los estamos guardando para poder acceder rápidamente a estos metadatos del último entrenamiento exitoso.

</details>

<h3 id="prediccion">Predicción</h3>
<details>
<summary>Predecir textos</summary>

Finalmente estamos listos para usar nuestro modelo entrenado para la inferencia. Agregaremos la operación para predecir una etiqueta a `main.py`:

<div class="highlight"><pre><span></span><code><span class="c1"># src/main.py</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">predict</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">utils</span>


<span class="k">def</span> <span class="nf">predict_tag</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predecir etiqueta para texto.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">run_id</span><span class="p">:</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG_DIR</span><span class="p">,</span> <span class="s2">&quot;run_id.txt&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">artifacts</span> <span class="o">=</span> <span class="n">load_artifacts</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">predict</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="p">[</span><span class="n">text</span><span class="p">],</span> <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">prediction</span>
</code></pre></div>

Esto implica crear la función `load_artifacts()` dentro de nuestro script `main.py`:

<div class="highlight"><pre><span></span><code><span class="c1"># src/main.py</span>
<span class="k">def</span> <span class="nf">load_artifacts</span><span class="p">(</span><span class="n">run_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cargar artefactos para un run_id determinado.&quot;&quot;&quot;</span>
    <span class="c1"># Localizar el directorio específicos de los artefactos</span>
    <span class="n">experiment_id</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">experiment_id</span>
    <span class="n">artifacts_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">MODEL_REGISTRY</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="s2">&quot;artifacts&quot;</span><span class="p">)</span>

    <span class="c1"># Cargar objetos desde la ejecución</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="o">**</span><span class="n">utils</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;args.json&quot;</span><span class="p">)))</span>
    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;vectorizer.pkl&quot;</span><span class="p">))</span>
    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">LabelEncoder</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;label_encoder.json&quot;</span><span class="p">))</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;model.pkl&quot;</span><span class="p">))</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;performance.json&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
        <span class="s2">&quot;label_encoder&quot;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="p">,</span>
        <span class="s2">&quot;vectorizer&quot;</span><span class="p">:</span> <span class="n">vectorizer</span><span class="p">,</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="s2">&quot;performance&quot;</span><span class="p">:</span> <span class="n">performance</span>
    <span class="p">}</span>
</code></pre></div>

Y definir la función `predict()` dentro de `predict.py`:

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predecir etiquetas para textos dados.&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;vectorizer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">custom_predict</span><span class="p">(</span>
        <span class="n">y_prob</span><span class="o">=</span><span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;label_encoder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">class_to_index</span><span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">])</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;label_encoder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;input_text&quot;</span><span class="p">:</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;predicted_tag&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div>

Comandos para predecir la etiqueta de texto:

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">main</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Transfer learning with transformers for text classification.&quot;</span>
<span class="n">run_id</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">CONFIG_DIR</span><span class="p">,</span> <span class="s2">&quot;run_id.txt&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">main</span><span class="o">.</span><span class="n">predict_tag</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">)</span>
</code></pre></div>

En la sección de documentación veremos como formatear nuestras funciones y clases correctamente.

</details>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../Empaquetado/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Empaquetado" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Empaquetado
            </div>
          </div>
        </a>
      
      
        
        <a href="../Logging/" class="md-footer__link md-footer__link--next" aria-label="Next: Logging" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Logging
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3a4b43e5.min.js"></script>
      
    
  </body>
</html>