
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Playbook de Ingeniería de Machine Learning de CoE Analytics">
      
      
        <meta name="author" content="YPF - CoE Analytics">
      
      
      <link rel="icon" href="../../resources/YPF.svg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.2.16">
    
    
      
        <title>Supervisión de los sistemas de Machine Learning - CoE MLOps Playbook</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1c3799f8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#supervision-de-los-sistemas-de-machine-learning" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CoE MLOps Playbook" class="md-header__button md-logo" aria-label="CoE MLOps Playbook" data-md-component="logo">
      
  <img src="../../resources/YPF.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CoE MLOps Playbook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Supervisión de los sistemas de Machine Learning
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/DJuanes/coe-mlops-playbook" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CoE MLOps Playbook" class="md-nav__button md-logo" aria-label="CoE MLOps Playbook" data-md-component="logo">
      
  <img src="../../resources/YPF.svg" alt="logo">

    </a>
    CoE MLOps Playbook
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DJuanes/coe-mlops-playbook" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Diseño
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Diseño" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Diseño
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Producto.md" class="md-nav__link">
        Producto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Ingeniería.md" class="md-nav__link">
        Ingeniería
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Proyecto.md" class="md-nav__link">
        Proyecto
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Datos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Datos" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Datos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Etiquetado.md" class="md-nav__link">
        Etiquetado
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Exploración.md" class="md-nav__link">
        Exploración
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Preprocesamiento.md" class="md-nav__link">
        Preprocesamiento
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Splitting.md" class="md-nav__link">
        Splitting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Aumento.md" class="md-nav__link">
        Aumento
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Modelado
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Modelado" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Modelado
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Líneas base.md" class="md-nav__link">
        Líneas base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Evaluación.md" class="md-nav__link">
        Evaluación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Seguimiento de experimentos.md" class="md-nav__link">
        Seguimiento de experimentos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Optimización.md" class="md-nav__link">
        Optimización
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5">
          Desarrollo
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Desarrollo" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Desarrollo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Empaquetado.md" class="md-nav__link">
        Empaquetado
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Organización.md" class="md-nav__link">
        Organización
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Logging.md" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Documentación.md" class="md-nav__link">
        Documentación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Estilismo.md" class="md-nav__link">
        Estilismo
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Makefile.md" class="md-nav__link">
        Makefile
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6">
          Inferencia
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Inferencia" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Inferencia
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/Línea de comando.md" class="md-nav__link">
        Línea de comando
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../coe-mlops-playbook/API RESTful.md" class="md-nav__link">
        API RESTful
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduccion" class="md-nav__link">
    Introducción
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#salud-del-sistema" class="md-nav__link">
    Salud del sistema
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance" class="md-nav__link">
    Performance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resultados-retrasados" class="md-nav__link">
    Resultados retrasados
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ponderacion-de-la-importancia" class="md-nav__link">
    Ponderación de la importancia
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#drift" class="md-nav__link">
    Drift
  </a>
  
    <nav class="md-nav" aria-label="Drift">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-drift" class="md-nav__link">
    Data drift
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#target-drift" class="md-nav__link">
    Target drift
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concept-drift" class="md-nav__link">
    Concept drift
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#localizacion-del-desfase" class="md-nav__link">
    Localización del desfase
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#midiendo-el-desfase" class="md-nav__link">
    Midiendo el desfase
  </a>
  
    <nav class="md-nav" aria-label="Midiendo el desfase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#expectativas" class="md-nav__link">
    Expectativas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#univariado" class="md-nav__link">
    Univariado
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multivariado" class="md-nav__link">
    Multivariado
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="supervision-de-los-sistemas-de-machine-learning">Supervisión de los sistemas de Machine Learning</h1>
<p>Aprenda a supervisar los sistemas de ML para identificar y abordar las fuentes de desviación para evitar el deterioro del rendimiento del modelo.</p>
<h2 id="introduccion">Introducción</h2>
<p>Aunque hayamos entrenado y evaluado a fondo nuestro modelo, el verdadero trabajo comienza una vez que lo desplegamos en producción.
Esta es una de las diferencias fundamentales entre la ingeniería de software tradicional y el desarrollo de ML.
Tradicionalmente, con el software determinista basado en reglas, la mayor parte del trabajo se realiza en la fase inicial y,
una vez desplegado, nuestro sistema funciona tal y como lo hemos definido.
Pero con el aprendizaje automático, no hemos definido explícitamente cómo funciona algo, sino que hemos utilizado los datos para diseñar una solución probabilística.
Este enfoque está sujeto a una degradación natural del rendimiento a lo largo del tiempo, así como a un comportamiento involuntario,
ya que los datos expuestos al modelo serán diferentes de aquellos con los que ha sido entrenado.
Esto no es algo que debamos tratar de evitar, sino más bien comprender y mitigar en la medida de lo posible.</p>
<h2 id="salud-del-sistema">Salud del sistema</h2>
<p>El primer paso para asegurar que nuestro modelo está funcionando bien es asegurarse de que el sistema real está funcionando como debería.
Esto puede incluir métricas específicas de las solicitudes de servicio, como la latencia, el rendimiento, las tasas de error, etc.,
así como la utilización de la infraestructura, tal como uso de CPU/GPU, memoria, etc.
La mayoría de los proveedores de la nube, e incluso las capas de orquestación, nos proporcionarán esta visión de la salud de nuestro sistema de forma gratuita a través de un dashboard.</p>
<h2 id="performance">Performance</h2>
<p>La siguiente capa de métricas que hay que supervisar tiene que ver con el rendimiento del modelo.
Puede tratarse de métricas de evaluación cuantitativas que hayamos utilizado durante la evaluación del modelo (exactitud, precisión, f1, etc.),
pero también de métricas de negocio clave en las que el modelo influye (ROI, tasa de clics, etc.).
Por lo general, nunca es suficiente con analizar las métricas de rendimiento acumuladas a lo largo de todo el periodo de tiempo desde que el modelo se ha desplegado.
En su lugar, deberíamos inspeccionar también el rendimiento a lo largo de un periodo de tiempo que sea significativo para nuestra aplicación.
Estas métricas deslizantes podrían ser más indicativas de la salud de nuestro sistema y podríamos ser capaces de identificar los problemas más rápidamente al no oscurecerlos con datos históricos.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Generar datos</span>
<span class="n">hourly_f1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">94</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">98</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">20</span><span class="p">))</span> <span class="o">+</span> \
            <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">92</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span> <span class="o">+</span> \
            <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">88</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span> <span class="o">+</span> \
            <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">86</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">92</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># f1 acumulativo</span>
<span class="n">cumulative_f1</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hourly_f1</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hourly_f1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 promedio acumulado en el último día: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cumulative_f1</span><span class="p">[</span><span class="o">-</span><span class="mi">24</span><span class="p">:])</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># f1 corredizo</span>
<span class="n">window_size</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">sliding_f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">hourly_f1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span><span class="o">/</span><span class="n">window_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deslizamiento promedio de f1 en el último día: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sliding_f1</span><span class="p">[</span><span class="o">-</span><span class="mi">24</span><span class="p">:])</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">hourly_f1</span><span class="p">),</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;threshold&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cumulative_f1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;cumulative&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sliding_f1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sliding&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre></div>
<p><img alt="performance_drift.png" src="../../resources/performance_drift.png" /></p>
<p>Puede que necesitemos monitorizar las métricas en varios tamaños de ventana para detectar la degradación del rendimiento lo antes posible.
En este caso estamos monitorizando el f1 global, pero podemos hacer lo mismo con slices de datos, clases individuales, etc.</p>
<h2 id="resultados-retrasados">Resultados retrasados</h2>
<p>Es posible que no siempre dispongamos de los resultados reales para determinar el rendimiento del modelo en producción. Para mitigar esto, podríamos:</p>
<ul>
<li>idear una señal aproximada que nos ayude a estimar el rendimiento del modelo. Por ejemplo, en nuestra tarea de predicción de etiquetas, podríamos utilizar las etiquetas reales
  que un autor atribuye a un proyecto como etiquetas intermedias hasta que tengamos etiquetas verificadas a partir de un proceso de anotación.</li>
<li>etiquetar un pequeño subconjunto de nuestro conjunto de datos en vivo para estimar el rendimiento. Este subconjunto debería intentar ser representativo de las distintas distribuciones de los datos reales.</li>
</ul>
<h2 id="ponderacion-de-la-importancia">Ponderación de la importancia</h2>
<p>Sin embargo, las señales aproximadas no siempre están disponibles para todas las situaciones porque no hay retroalimentación sobre las salidas del sistema ML o está demasiado retrasada.
Para estas situaciones, una línea de investigación reciente se basa en el único componente que está disponible en todas las situaciones: los datos de entrada.
La idea central es desarrollar funciones slicing que puedan capturar potencialmente las formas en que nuestros datos pueden experimentar un cambio de distribución.
Estas funciones deben capturar slice obvios, como las etiquetas de clase o diferentes valores de features categóricos, pero también slices basados en metadatos implícitos.
Estas funciones de slice se aplican a nuestro conjunto de datos etiquetados para crear matrices con las etiquetas correspondientes. Las mismas funciones se aplican a nuestros datos de producción
no etiquetados para aproximar lo que serían las etiquetas ponderadas. Con esto, podemos determinar el rendimiento aproximado. La intuición aquí es que podemos aproximar mejor el rendimiento
en nuestro conjunto de datos sin etiquetar basándonos en la similitud entre la matriz de slices etiquetados y la matriz de slices sin etiquetar.
Una dependencia central de esta suposición es que nuestras funciones de slice son lo suficientemente completas como para capturar las causas del cambio de distribución.</p>
<h2 id="drift">Drift</h2>
<p>En primer lugar, debemos comprender los diferentes tipos de problemas que pueden hacer que el rendimiento de nuestro modelo decaiga (model drift).
La mejor manera de hacerlo es observar todas las piezas móviles de lo que estamos tratando de modelar y cómo cada una de ellas puede experimentar un desfase.</p>
<table>
<thead>
<tr>
<th>Entidad</th>
<th>Descripción</th>
<th>Drift</th>
</tr>
</thead>
<tbody>
<tr>
<td>X</td>
<td>entradas (features)</td>
<td>data drift -&gt; P(X) != Pref(X)</td>
</tr>
<tr>
<td>y</td>
<td>salidas (ground-truth)</td>
<td>target drift -&gt; P(y) != Pref(y)</td>
</tr>
<tr>
<td>P(y/X)</td>
<td>relación actual entre X e y</td>
<td>concept drift -&gt; P(y/X) != Pref(y/X)</td>
</tr>
</tbody>
</table>
<h3 id="data-drift">Data drift</h3>
<p>Data drift se produce cuando la distribución de los datos de producción es diferente a la de los datos de entrenamiento.
El modelo no está preparado para hacer frente a este desfase y, por tanto, sus predicciones pueden no ser fiables.
La causa real puede atribuirse a cambios naturales en el mundo real, pero también a problemas sistémicos como la falta de datos, errores de canalización, cambios de esquema, etc.
Es importante inspeccionar los datos desviados y rastrearlos a lo largo de su canalización para identificar cuándo y dónde se introdujo la desviación.</p>
<h3 id="target-drift">Target drift</h3>
<p>También podemos experimentar una deriva en nuestros resultados. Esto puede ser un cambio en las distribuciones, pero también la eliminación o adición de nuevas clases con tareas categóricas.
Aunque el reentrenamiento puede mitigar el deterioro del rendimiento causado por la deriva de los datos,
a menudo puede evitarse con una comunicación adecuada entre líneas sobre nuevas clases, cambios de esquema, etc.</p>
<h3 id="concept-drift">Concept drift</h3>
<p>Además de la deriva de los datos de entrada y de salida, también podemos ver que la relación actual entre ellos también se desvíe.
Este desvio hace que nuestro modelo sea ineficaz porque los patrones que aprendió a trazar entre las entradas y salidas originales ya no son relevantes.</p>
<h2 id="localizacion-del-desfase">Localización del desfase</h2>
<p>Ahora que hemos identificado los diferentes tipos de desfase, tenemos que aprender a localizarla y a medirla con frecuencia. Estas son las limitaciones que debemos tener en cuenta:</p>
<ul>
<li>ventana de referencia: el conjunto de puntos con los que se comparan las distribuciones de datos de producción para identificar el desafase.</li>
<li>ventana de prueba: el conjunto de puntos que se comparan con la ventana de referencia para determinar si se ha producido un desafase.</li>
</ul>
<p>Dado que se trata de una detección de desviaciones en línea, podemos emplear un enfoque de ventana fija o deslizante para identificar nuestro conjunto de puntos para la comparación.
Normalmente, la ventana de referencia es un subconjunto fijo y reciente de los datos de entrenamiento, mientras que la ventana de prueba se desliza en el tiempo.
<a href="https://scikit-multiflow.github.io/">Scikit-multiflow</a> proporciona un conjunto de herramientas para las técnicas de detección de concept drift directamente en los datos de flujo.
El paquete ofrece la funcionalidad de ventanas y medias móviles e incluso métodos en torno a conceptos como la deriva conceptual gradual.</p>
<h2 id="midiendo-el-desfase">Midiendo el desfase</h2>
<p>Una vez que tenemos la ventana de puntos que queremos comparar, necesitamos saber cómo compararlos.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">great_expectations</span> <span class="k">as</span> <span class="nn">ge</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Cargar proyectos etiquetados</span>
<span class="n">projects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/GokuMohandas/Made-With-ML/main/datasets/projects.csv&quot;</span><span class="p">)</span>
<span class="n">tags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/GokuMohandas/Made-With-ML/main/datasets/tags.csv&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ge</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">PandasDataset</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">projects</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">description</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<h3 id="expectativas">Expectativas</h3>
<p>La primera forma de medición puede estar basada en reglas, como la validación de las expectativas en torno a los valores que faltan, los tipos de datos, los rangos de valores, etc..
La diferencia con las pruebas de datos es que ahora validaremos las expectativas en datos de producción en vivo.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Datos de producción simulados</span>
<span class="n">prod_df</span> <span class="o">=</span> <span class="n">ge</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">PandasDataset</span><span class="p">([{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;world&quot;</span><span class="p">}])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Suite de expectativas</span>
<span class="n">df</span><span class="o">.</span><span class="n">expect_column_values_to_not_be_null</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">expect_column_values_to_be_of_type</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
<span class="n">expectation_suite</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">get_expectation_suite</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Validar datos de referencia</span>
<span class="n">df</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">expectation_suite</span><span class="o">=</span><span class="n">expectation_suite</span><span class="p">,</span> <span class="n">only_return_failures</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;statistics&quot;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Validar datos de producción</span>
<span class="n">prod_df</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">expectation_suite</span><span class="o">=</span><span class="n">expectation_suite</span><span class="p">,</span> <span class="n">only_return_failures</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;statistics&quot;</span><span class="p">]</span>
</code></pre></div>
<p>Una vez que hayamos validado nuestras expectativas basadas en reglas, tenemos que medir cuantitativamente el desafase en los diferentes features de nuestros datos.</p>
<h3 id="univariado">Univariado</h3>
<p>Nuestra tarea puede incluir características univariantes (1D) que querremos controlar.
Aunque hay muchos tipos de pruebas de hipótesis que podemos utilizar, una opción popular es la prueba de Kolmogorov-Smirnov (KS).</p>
<p><strong>Kolmogorov-Smirnov (KS) test</strong>
El test KS determina la distancia máxima entre las funciones de densidad acumulativa de dos distribuciones.
En este caso, mediremos si hay alguna deriva en el tamaño de nuestro feature de texto de entrada entre dos subconjuntos de datos diferentes.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">alibi_detect.cd</span> <span class="kn">import</span> <span class="n">KSDrift</span>


<span class="c1"># Referencia</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;num_tokens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)))</span>
<span class="n">ref</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;num_tokens&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">200</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Inicializar detector de deriva</span>
<span class="n">length_drift_detector</span> <span class="o">=</span> <span class="n">KSDrift</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">p_val</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># No drift</span>
<span class="n">no_drift</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;num_tokens&quot;</span><span class="p">][</span><span class="mi">200</span><span class="p">:</span><span class="mi">400</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">no_drift</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">length_drift_detector</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">no_drift</span><span class="p">,</span> <span class="n">return_p_val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Drift</span>
<span class="n">drift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">drift</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">length_drift_detector</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">drift</span><span class="p">,</span> <span class="n">return_p_val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p><strong>Chi-squared test</strong>
Del mismo modo, para los datos categóricos, podemos aplicar la prueba chi-squared de Pearson para determinar si una frecuencia de eventos en la producción es coherente con una distribución de referencia.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">alibi_detect.cd</span> <span class="kn">import</span> <span class="n">ChiSquareDrift</span>


<span class="c1"># Referencia</span>
<span class="n">df</span><span class="o">.</span><span class="n">token_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">num_tokens</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;small&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;medium&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span><span class="mi">25</span> <span class="k">else</span> <span class="s2">&quot;large&quot;</span><span class="p">))</span>
<span class="n">ref</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">token_count</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">200</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Inicializar detector de deriva</span>
<span class="n">target_drift_detector</span> <span class="o">=</span> <span class="n">ChiSquareDrift</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">p_val</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># No drift</span>
<span class="n">no_drift</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">token_count</span><span class="p">[</span><span class="mi">200</span><span class="p">:</span><span class="mi">400</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">no_drift</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">target_drift_detector</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">no_drift</span><span class="p">,</span> <span class="n">return_p_val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Drift</span>
<span class="n">drift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;small&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;medium&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">40</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;large&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">drift</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">target_drift_detector</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">drift</span><span class="p">,</span> <span class="n">return_p_val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h3 id="multivariado">Multivariado</h3>
<p>La medición de la deriva es bastante sencilla para los datos univariados, pero difícil para los datos multivariados.
Resumiremos el enfoque de reducción y medición que se expone en el siguiente documento: <a href="https://arxiv.org/abs/1810.11953">Failing Loudly: An Empirical Study of Methods for Detecting Dataset Shift</a>.
Hemos vectorizado nuestro texto utilizando tf-idf, que tiene una alta dimensionalidad y no es semánticamente rico en contexto.
Sin embargo, normalmente con el texto se utilizan incrustaciones de palabras/caracteres. Así que para ilustrar cómo sería la detección de desfase en datos multivariados,
vamos a representar nuestro texto utilizando incrustaciones preentrenadas.
Empezaremos cargando el tokenizador desde un modelo preentrenado.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span>


<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;allenai/scibert_scivocab_uncased&quot;</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
<span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">vocab_size</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Tokenizar entradas</span>
<span class="n">encoded_input</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">encoded_input</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
<span class="n">masks</span> <span class="o">=</span> <span class="n">encoded_input</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Decode</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Tokens de subpalabras</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_ids_to_tokens</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></div>
<p>A continuación, cargaremos los pesos del modelo preentrenado y utilizaremos el objeto TransformerEmbedding para extraer las incrustaciones del estado oculto.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">alibi_detect.models.pytorch</span> <span class="kn">import</span> <span class="n">TransformerEmbedding</span>

<span class="c1"># Capa de incrustación</span>
<span class="n">emb_type</span> <span class="o">=</span> <span class="s2">&quot;hidden_state&quot;</span>
<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)]</span>  <span class="c1"># last 8 layers</span>
<span class="n">embedding_layer</span> <span class="o">=</span> <span class="n">TransformerEmbedding</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">emb_type</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Dimensión de incrustación</span>
<span class="n">embedding_dim</span> <span class="o">=</span> <span class="n">embedding_layer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">word_embeddings</span><span class="o">.</span><span class="n">embedding_dim</span>
<span class="n">embedding_dim</span>
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3a4b43e5.min.js"></script>
      
    
  </body>
</html>